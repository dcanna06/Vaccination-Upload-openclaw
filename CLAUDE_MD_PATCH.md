# claude.md Corrections — PRODA Auth & AIR Values

> **Date**: 2026-02-08
> **Context**: All PRODA JWT claims have been proven correct via SoapUI 5.7.2 device activation + token retrieval against the vendor test environment. The access token was decoded and verified. The previous values in claude.md were based on early assumptions that turned out to be wrong.

---

## CHANGE 1: Environment Variables — PRODA section (lines ~187-195)

### FIND:
```
# === PRODA B2B Authentication ===
PRODA_TOKEN_ENDPOINT=https://proda.humanservices.gov.au/piaweb/api/b2b/v1/token
PRODA_MINOR_ID=                        # e.g., MMS00001
PRODA_DEVICE_NAME=                     # Device name registered with PRODA
PRODA_ORG_ID=                          # PRODA Organisation ID (RA number)
PRODA_JKS_BASE64=                      # Base64-encoded JKS keystore file
PRODA_JKS_PASSWORD=                    # JKS keystore password
PRODA_KEY_ALIAS=                       # Private key alias within JKS
PRODA_AUDIENCE=https://medicareaustralia.gov.au/MCOL
```

### REPLACE WITH:
```
# === PRODA B2B Authentication ===
PRODA_TOKEN_ENDPOINT_VENDOR=https://vnd.proda.humanservices.gov.au/mga/sps/oauth/oauth20/token
PRODA_TOKEN_ENDPOINT_PROD=https://proda.humanservices.gov.au/mga/sps/oauth/oauth20/token
PRODA_MINOR_ID=                        # e.g., WRR00000 — Minor ID assigned to this healthcare location
PRODA_DEVICE_NAME=                     # Device name registered with PRODA (e.g., DavidTestLaptop2)
PRODA_ORG_ID=                          # PRODA Organisation ID / RA number (e.g., 2330016739)
PRODA_JKS_BASE64=                      # Base64-encoded JKS keystore file (generated by SoapUI)
PRODA_JKS_PASSWORD=Pass-123            # JKS keystore password (SoapUI default)
PRODA_KEY_ALIAS=proda-alias            # Private key alias within JKS (SoapUI default)
PRODA_JWT_AUDIENCE=https://proda.humanservices.gov.au
PRODA_CLIENT_ID=soape-testing-client-v2  # Vendor environment client ID
PRODA_ACCESS_TOKEN_AUDIENCE=https://proda.humanservices.gov.au  # accessTokenAudience value
```

---

## CHANGE 2: PRODA B2B Authentication — Token Acquisition Flow (lines ~399-418)

### FIND:
```
## PRODA B2B Authentication

### Token Acquisition Flow

```
1. Load private key from JKS keystore (stored in Key Vault)
2. Build JWT assertion:
   - iss: {PRODA_MINOR_ID}
   - sub: {PRODA_DEVICE_NAME}
   - aud: {PRODA_AUDIENCE}  (https://medicareaustralia.gov.au/MCOL)
   - exp: now + 5 minutes
   - iat: now
   - jti: unique UUID
   - Sign with RS256 using JKS private key
3. POST to PRODA_TOKEN_ENDPOINT:
   - grant_type: urn:ietf:params:oauth:grant-type:jwt-bearer
   - assertion: {signed_jwt}
4. Response: { access_token, token_type: "Bearer", expires_in: 3600 }
5. Cache token in memory. Refresh at 50-minute mark (before 60-min expiry).
```
```

### REPLACE WITH:
```
## PRODA B2B Authentication

### Token Acquisition Flow (PROVEN — verified against vendor test environment 2026-02-08)

```
1. Load private key from JKS keystore
   - JKS generated by SoapUI during device activation
   - Alias: "proda-alias"
   - Password: "Pass-123"
   - In production: retrieve from Azure Key Vault → decode Base64 → load in memory

2. Build JWT assertion with these EXACT claims:
   HEADER:
   - alg: "RS256"
   - kid: {PRODA_DEVICE_NAME}              ← device name, NOT org ID

   PAYLOAD:
   - iss: {PRODA_ORG_ID}                   ← organisation ID (e.g., "2330016739")
   - sub: {PRODA_DEVICE_NAME}              ← device name (e.g., "DavidTestLaptop2")
   - aud: "https://proda.humanservices.gov.au"  ← FIXED audience string
   - token.aud: {PRODA_ACCESS_TOKEN_AUDIENCE}   ← custom claim for access token audience
   - exp: now + 10 minutes
   - iat: now

   Sign with RS256 using JKS private key

3. POST to PRODA_TOKEN_ENDPOINT (vendor or prod):
   Content-Type: application/x-www-form-urlencoded
   Body:
   - grant_type: urn:ietf:params:oauth:grant-type:jwt-bearer
   - assertion: {signed_jwt}
   - client_id: {PRODA_CLIENT_ID}          ← "soape-testing-client-v2" for vendor

4. Response: { access_token, token_type: "bearer", expires_in: 3600, key_expiry, device_expiry }
5. Cache token in memory. Refresh at 50-minute mark (before 60-min expiry).
```

### Proven Token Payload (decoded from successful token retrieval):
```json
{
  "sub": "2330016739",                         // orgId
  "iss": "https://proda.humanservices.gov.au",
  "aud": "PRODA.UNATTENDED.B2B",
  "proda.swinst": "DavidTestLaptop2",          // deviceName
  "proda.type": "UNATTENDED.B2B",
  "proda.org": "2330016739",
  "proda.aud": "https://proda.humanservices.gov.au",
  "proda.rp": "PRODA",
  "proda.sp": ["PRODA"]
}
```

### CRITICAL NOTES:
- JWT `iss` is ORG_ID, NOT Minor ID (previous claude.md was WRONG)
- JWT `aud` is "https://proda.humanservices.gov.au", NOT "https://medicareaustralia.gov.au/MCOL"
- JWT `kid` header MUST be the device name
- `token.aud` is a custom claim in the JWT payload, NOT the standard `aud` claim
- `client_id` is a POST form parameter, NOT a JWT claim
- Token endpoint URL differs between vendor and production environments
- JKS MUST be generated by SoapUI's ActivateDevice test suite — Python-generated keys are NOT compatible
```

---

## CHANGE 3: Gender Values — add X (lines ~283, ~492-493, ~517, ~649)

### Line ~283 (request shape comment):
FIND: `"gender": "F",                      // M, F, I, U`
REPLACE: `"gender": "F",                      // M, F, I, U, X`

### Lines ~492-493 (Gender Values section):
FIND:
```
- `M` = Male, `F` = Female, `I` = Intersex/Indeterminate, `U` = Unknown
- **In Excel template**: accept M/F/I/U or Male/Female/Intersex/Unknown and map accordingly
```
REPLACE:
```
- `M` = Male, `F` = Female, `I` = Intersex/Indeterminate, `U` = Unknown, `X` = Not Stated/Inadequately Described
- **Note**: Gender value `X` added in AIR Record Encounter V6.0.7 (June 2025)
- **In Excel template**: accept M/F/I/U/X or Male/Female/Intersex/Unknown/NotStated and map accordingly
```

### Line ~517 (Excel template Gender column):
FIND: `| G   | Gender                     | individual.personalDetails.gender       | Yes      | M/F/I/U             |`
REPLACE: `| G   | Gender                     | individual.personalDetails.gender       | Yes      | M/F/I/U/X           |`

### Line ~649 (client-side validation):
FIND: `- Gender not in M/F/I/U`
REPLACE: `- Gender not in M/F/I/U/X`

---

## CHANGE 4: Route of Administration — add NS (lines ~306, ~524)

### Line ~306 (request shape comment):
FIND: `"routeOfAdministration": "IM"   // IM, SC, ID, OR, IN, NAS`
REPLACE: `"routeOfAdministration": "IM"   // IM, SC, ID, OR, IN, NAS, NS`

### Line ~524 (Excel template Route column):
FIND: `| N   | Route of Administration    | episodes[].routeOfAdministration        | Cond     | IM/SC/ID/OR/IN/NAS  |`
REPLACE: `| N   | Route of Administration    | episodes[].routeOfAdministration        | Cond     | IM/SC/ID/OR/IN/NAS/NS |`

### Add note after the Route column in Excel Template section:
```
**Note**: Route value `NS` (Nasal) added in AIR Record Encounter V6.0.7 (October 2025). Distinct from `NAS` (also Nasal, legacy code).
```

---

## CHANGE 5: JKS Keystore Handling (lines ~422-427)

### FIND:
```
### JKS Keystore Handling

- Store JKS file as Base64-encoded secret in Azure Key Vault
- At runtime: retrieve from Key Vault → decode Base64 → load with `pyjks` or equivalent
- Never write the decoded JKS to the filesystem in production
- For local dev: mount from `.env` file as `PRODA_JKS_BASE64`
```

### REPLACE WITH:
```
### JKS Keystore Handling

- JKS MUST be generated by SoapUI's ActivateDevice test suite (Python/Java-generated keys are NOT compatible with the PRODA token server)
- SoapUI generates the JKS with alias `proda-alias` and password `Pass-123`
- Store JKS file as Base64-encoded secret in Azure Key Vault
- At runtime: retrieve from Key Vault → decode Base64 → load with `pyjks` or Java KeyStore
- Never write the decoded JKS to the filesystem in production
- For local dev: mount from `.env` file as `PRODA_JKS_BASE64`
- Device key expiry: must be monitored and renewed before expiry (current: 6 months from activation)
- Device expiry: 5 years from activation

### Vendor Test Environment Credentials (current)
- Org ID: 2330016739
- Device Name: DavidTestLaptop2
- Device Status: ACTIVE
- Key Expiry: 2026-08-06
- Device Expiry: 2031-04-07
- JKS Location (local): C:\Users\david\Downloads\ProdaCertificates\DavidTestLaptop2_vnd.jks
- Token Endpoint: https://vnd.proda.humanservices.gov.au/mga/sps/oauth/oauth20/token
- Client ID: soape-testing-client-v2
```

---

## Summary of All Incorrect Values That Were in claude.md

| Parameter | OLD (WRONG) | NEW (PROVEN) |
|---|---|---|
| Token endpoint | `https://proda.humanservices.gov.au/piaweb/api/b2b/v1/token` | `https://vnd.proda.humanservices.gov.au/mga/sps/oauth/oauth20/token` (vendor) |
| JWT iss | `{PRODA_MINOR_ID}` | `{PRODA_ORG_ID}` |
| JWT aud | `https://medicareaustralia.gov.au/MCOL` | `https://proda.humanservices.gov.au` |
| JWT kid header | Not documented | `{PRODA_DEVICE_NAME}` (REQUIRED) |
| JWT token.aud | Not documented | `{PRODA_ACCESS_TOKEN_AUDIENCE}` (REQUIRED) |
| JWT exp offset | 5 minutes | 10 minutes |
| POST client_id | Not documented | `soape-testing-client-v2` (REQUIRED) |
| PRODA_AUDIENCE env | `https://medicareaustralia.gov.au/MCOL` | `https://proda.humanservices.gov.au` |
| JKS alias | Variable | `proda-alias` (SoapUI default) |
| JKS password | Variable | `Pass-123` (SoapUI default) |
| Gender values | M/F/I/U | M/F/I/U/X |
| Route values | IM/SC/ID/OR/IN/NAS | IM/SC/ID/OR/IN/NAS/NS |
