name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  ACR_NAME: airvaccinationacr
  RESOURCE_GROUP: air-vaccination-rg
  BACKEND_APP: air-vaccination-backend
  FRONTEND_APP: air-vaccination-frontend

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        run: pip install -r backend/requirements.txt

      - name: Run backend tests (skip integration/e2e — require live vendor API)
        run: python -m pytest backend/tests/ -v --tb=short -m "not integration"
        env:
          APP_ENV: vendor

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm test

  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name $ACR_NAME

      - name: Build and push backend image
        run: |
          docker build -t $ACR_NAME.azurecr.io/air-backend:${{ github.sha }} \
                        -t $ACR_NAME.azurecr.io/air-backend:latest \
                        ./backend
          docker push $ACR_NAME.azurecr.io/air-backend:${{ github.sha }}
          docker push $ACR_NAME.azurecr.io/air-backend:latest

      - name: Build and push frontend image
        run: |
          docker build -t $ACR_NAME.azurecr.io/air-frontend:${{ github.sha }} \
                        -t $ACR_NAME.azurecr.io/air-frontend:latest \
                        ./frontend
          docker push $ACR_NAME.azurecr.io/air-frontend:${{ github.sha }}
          docker push $ACR_NAME.azurecr.io/air-frontend:latest

      - name: Deploy backend
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.BACKEND_APP }}
          images: ${{ env.ACR_NAME }}.azurecr.io/air-backend:${{ github.sha }}

      - name: Deploy frontend
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.FRONTEND_APP }}
          images: ${{ env.ACR_NAME }}.azurecr.io/air-frontend:${{ github.sha }}

      - name: Wait for backend startup
        run: |
          echo "Waiting for backend to start..."
          for i in $(seq 1 30); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${BACKEND_APP}.azurewebsites.net/health" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Backend is healthy"
              break
            fi
            echo "  Attempt $i/30 — status: $STATUS"
            sleep 10
          done

      - name: Run Alembic migrations
        run: |
          az webapp ssh --resource-group $RESOURCE_GROUP --name $BACKEND_APP \
            --command "cd /app && alembic upgrade head" --timeout 60 || \
          echo "⚠ SSH migration failed — run manually: az webapp ssh --resource-group $RESOURCE_GROUP --name $BACKEND_APP"
